<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hosszú távú előrejelzés - Nyíregyháza</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            /* Éjszakai téma (Alapértelmezett) */
            --bg-widget-night: rgba(28, 39, 58, 0.85);
            --border-widget-night: rgba(56, 189, 248, 0.35);
            --accent-interactive-night: #00BFFF;
            --text-primary-night: #EAEAEA;
            --text-secondary-night: #BCCCDC;

            /* Nappali téma */
            --bg-widget-day: linear-gradient(160deg, rgba(55, 65, 81, 0.85) 0%, rgba(30, 41, 59, 0.8) 100%);
            --border-widget-day: rgba(255, 255, 255, 0.15);
            --accent-interactive-day: #007AFF;
            --text-primary-day: #FFFFFF;
            --text-secondary-day: #EAEAEA;
            
            /* Dinamikusan változó téma */
            --current-sky-color-top: #0a0215;
            --current-sky-color-bottom: #1d0f3b;
            --current-text-color: var(--text-primary-night);
            --current-text-muted-color: var(--text-secondary-night);
            --current-icon-color: var(--accent-interactive-night);
            --current-widget-bg: var(--bg-widget-night);
            --current-widget-border: var(--border-widget-night);
            --current-container-border-color: var(--border-widget-night);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            font-weight: 500; 
            background-color: #0a0215; 
            min-height: 100vh; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center; 
            text-align: center; 
            padding: 20px; 
            box-sizing: border-box; 
            position: relative; 
            overflow-x: hidden; 
        }
        
        body[data-theme="day"] { 
            --current-text-color: var(--text-primary-day); 
            --current-text-muted-color: var(--text-secondary-day); 
            --current-icon-color: var(--accent-interactive-day); 
            --current-widget-bg: var(--bg-widget-day); 
            --current-widget-border: var(--border-widget-day); 
            --current-container-border-color: var(--border-widget-day); 
        }

        .sky-gradient-overlay { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: linear-gradient(to bottom, var(--current-sky-color-top), var(--current-sky-color-bottom)); 
            transition: background 2s ease-in-out; 
            z-index: -1; 
        }
        
        .main-container { 
            width: 100%; 
            max-width: 1600px; 
            margin: 0 auto;
            color: var(--current-text-color); 
            transition: color 0.6s ease-in-out;
            padding-top: 20px;
        }

        .header-wrapper {
            width: 100%;
            margin-bottom: 24px;
            padding: 0 4px;
            box-sizing: border-box;
            text-align: left;
        }

        .title-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px 16px;
            margin-bottom: 8px;
        }

        .header-wrapper h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--current-text-color);
            margin: 0;
            line-height: 1;
        }
        .header-wrapper h1 .subtitle {
            font-weight: 400;
            font-size: 0.9em;
            color: var(--current-text-muted-color);
        }

        .meta-info {
            font-size: 13px;
            font-weight: 500;
            color: var(--current-text-muted-color);
            display: flex;
            flex-wrap: wrap;
            gap: 4px 12px;
            align-items: center;
        }
        .meta-info #last-updated-time::before {
            content: '•';
            margin-right: 12px;
            opacity: 0.6;
        }
        
        #week-selector {
            background-color: rgba(0,0,0,0.25);
            color: var(--current-text-color);
            border: 1px solid var(--current-container-border-color);
            border-radius: 8px;
            padding: 8px 14px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23BCCCDC' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.6rem center;
            background-repeat: no-repeat;
            background-size: 1.1em 1.1em;
            padding-right: 2.4rem;
        }

        #week-selector:hover {
            border-color: var(--current-icon-color);
        }
        #week-selector option {
            background-color: #374151;
            color: #F3F4F6;
        }

        .forecast-container { 
            width: 100%; 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 16px; 
            margin: 0 auto; 
        }
        .forecast-container.eight-columns {
            grid-template-columns: repeat(8, 1fr);
        }

        @keyframes card-entry { 
            from { opacity: 0; transform: translateY(25px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .loading-message { font-size: 18px; padding: 40px; grid-column: 1 / -1; }
        
        .forecast-day-card { 
            display: flex; 
            flex-direction: column; 
            padding: 16px; 
            border-radius: 18px; 
            background: var(--current-widget-bg); 
            border: 1px solid var(--current-widget-border); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            color: var(--current-text-color); 
            transition: all 0.4s ease-in-out; 
            backdrop-filter: blur(20px) saturate(180%); 
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 6px solid var(--temp-color, var(--current-icon-color)); 
            opacity: 0; 
            animation: card-entry 0.6s ease-out forwards; 
            animation-delay: calc(var(--day-index) * 70ms); 
        }
        .forecast-day-card:hover { 
            transform: translateY(-8px) scale(1.03); 
            box-shadow: 0 12px 40px rgba(0,0,0,0.45); 
            border-color: var(--current-icon-color);
        }
        
        .forecast-day-card.today { 
            transform: scale(1.05);
            border: 2px solid var(--current-icon-color);
            border-top-width: 6px;
        }
        .forecast-day-card.today .forecast-day-name, .forecast-day-card.tomorrow .forecast-day-name { font-size: 19px; font-weight: 800; color: var(--current-icon-color); }

        .forecast-header { text-align: center; margin-bottom: 10px; }
        .forecast-day-name { font-size: 17px; font-weight: 700; }
        .forecast-date { font-size: 13px; font-weight: 500; color: var(--current-text-muted-color); }
        .forecast-temps { font-size: 28px; font-weight: 800; display: flex; justify-content: center; align-items: baseline; gap: 14px; padding: 12px 0; border-top: 1px solid var(--current-container-border-color); margin: 10px 0 0 0; }
        .forecast-temp-min { font-size: 0.65em; color: var(--current-text-muted-color); font-weight: 500; }
        
        .forecast-sun-details {
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--current-text-muted-color);
            padding: 8px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--current-container-border-color);
        }
        .forecast-sun-details > span {
            display: flex;
            align-items: center;
        }
        .icon-combo {
            display: inline-flex;
            align-items: center;
            margin-right: 8px;
        }
        .icon-sunrise { color: #facc15; }
        .icon-sunset { color: #f97316; }
        .icon-arrow {
            font-size: 0.7em;
            margin-left: -5px;
            position: relative;
            color: #ffffff;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }
        .icon-arrow.up { top: -3px; }
        .icon-arrow.down { top: 3px; }

        .forecast-part { margin-top: 10px; flex-grow: 1; }
        .forecast-part:first-of-type { padding-bottom: 10px; border-bottom: 1px solid var(--current-container-border-color); }
        .forecast-part-header { display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 700; margin-bottom: 6px; }
        .forecast-part-header i { font-size: 1.3em; margin-right: 8px; color: var(--current-icon-color); width: 22px; text-align: center; }
        .forecast-part-details { font-size: 13px; color: var(--current-text-muted-color); line-height: 1.6; text-align: center; }
        .forecast-part-details p { margin: 4px 0; }
        .forecast-part-details p i { vertical-align: middle; }

        @media (max-width: 1400px) {
            .forecast-container { grid-template-columns: repeat(4, 1fr); }
            .forecast-container.eight-columns { grid-template-columns: repeat(4, 1fr); }
        }
        @media (max-width: 800px) {
            .forecast-container { grid-template-columns: repeat(2, 1fr); }
            .forecast-container.eight-columns { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 500px) {
            .forecast-container { grid-template-columns: 1fr; }
            .forecast-container.eight-columns { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body data-theme="night">
    <div class="sky-gradient-overlay"></div>

    <div class="main-container">
        <div class="header-wrapper">
            <div class="title-container">
                <h1>Nyíregyháza <span class="subtitle">távolabbi kilátások</span></h1>
                <select id="week-selector" aria-label="Válasszon időszakot"></select>
            </div>
            <div class="meta-info">
                <span id="date-range-display">Betöltés...</span>
                <span id="last-updated-time">Frissítés...</span>
            </div>
        </div>
    
        <div class="forecast-container" id="forecast-container">
            <div class="loading-message">Előrejelzés betöltése...</div>
        </div>
    </div>
    
    <script>
        const weatherComApiKey = 'e1f10a1e78da46f5b10a1e78da96f525';
        const NYIREGYHAZA_COORDS = { lat: 47.9550, lon: 21.7160 };
        const NO_DATA_STRING = 'N/A';
        const REFRESH_INTERVAL_MS = 15 * 60 * 1000; // 15 perc
        let allForecastDays = [];

        const SKY_PALETTE = {
            DEEP_NIGHT: { top: '#0a0215', bottom: '#1d0f3b' },      // Éjfél után
            PRE_DAWN:   { top: '#110d2e', bottom: '#3a265e' },      // Napkelte előtt ~90 perccel
            DAWN:       { top: '#2c2a65', bottom: '#785a9b' },      // Napkelte előtt ~45 perccel
            SUNRISE:    { top: '#5f69c4', bottom: '#f89a7a' },      // Napkelte környékén
            MORNING:    { top: '#7DD3FC', bottom: '#C4EFFF' },      // Napkelte után
            LATE_MORNING:{ top: '#5bb8f2', bottom: '#a6ddf6' },      // Délelőtt
            NOON:       { top: '#2e92e1', bottom: '#84c5f1' },      // Dél körül
            AFTERNOON:  { top: '#0e67b1', bottom: '#f4a974' },      // Délután
            SUNSET:     { top: '#1b328a', bottom: '#f77b5a' },      // Napnyugta környékén
            DUSK:       { top: '#1d215b', bottom: '#87517c' },      // Napnyugta után ~45 perccel
            EVENING:    { top: '#0f0e34', bottom: '#483475' }       // Este
        };

        function formatLastUpdated(date) {
            const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            return `Frissítve: ${new Intl.DateTimeFormat('hu-HU', options).format(date)}`;
        }

        function formatValue(value, unit = '', precision = 1, notAvailableString = NO_DATA_STRING) {
            if (value === null || typeof value === 'undefined' || (typeof value === 'number' && isNaN(value))) return notAvailableString;
            if (typeof value === 'number') return `${value.toFixed(precision)}${unit}`;
            return `${value}${unit}`;
        }
        
        function formatPrecipitation(value) {
            if (value === null || typeof value === 'undefined' || isNaN(value)) return '0 mm';
            return `${value.toFixed(1)} mm`;
        }

        function formatForecastDate(isoDateString) {
            if (!isoDateString) return '';
            const date = new Date(isoDateString);
            const options = { month: 'short', day: 'numeric' };
            return new Intl.DateTimeFormat('hu-HU', options).format(date);
        }

        function formatTime(isoDateString) {
            if (!isoDateString) return NO_DATA_STRING;
            const date = new Date(isoDateString);
            const options = { hour: '2-digit', minute: '2-digit', hour12: false };
            return new Intl.DateTimeFormat('hu-HU', options).format(date);
        }
        
        function degreesToCompass(degrees) {
            if (degrees === null || typeof degrees === 'undefined') return '-';
            degrees = (parseFloat(degrees) % 360 + 360) % 360;
            const directions = ["É", "ÉÉK", "ÉK", "KÉK", "K", "KDK", "DK", "DDK", "D", "DDNY", "DNY", "NYDNY", "NY", "NYÉNY", "ÉNY", "ÉÉNY"];
            return directions[Math.round(degrees / 22.5) % 16];
        }

        function mapTwcIconToFontAwesome(iconCode, dayOrNight) {
            const isDay = dayOrNight === 'D';
            const iconMap = { 32: 'fas fa-sun', 36: 'fas fa-sun', 31: 'fas fa-moon', 33: 'fas fa-moon', 34: isDay ? 'fas fa-sun' : 'fas fa-cloud-moon', 29: isDay ? 'fas fa-cloud-sun' : 'fas fa-cloud-moon', 30: isDay ? 'fas fa-cloud-sun' : 'fas fa-cloud-moon', 27: 'fas fa-cloud', 28: 'fas fa-cloud', 26: 'fas fa-cloud', 11: 'fas fa-cloud-showers-heavy', 12: 'fas fa-cloud-showers-heavy', 40: 'fas fa-cloud-showers-heavy', 39: isDay ? 'fas fa-cloud-sun-rain' : 'fas fa-cloud-moon-rain', 45: isDay ? 'fas fa-cloud-sun-rain' : 'fas fa-cloud-moon-rain', 3: 'fas fa-cloud-bolt', 4: 'fas fa-cloud-bolt', 37: 'fas fa-cloud-bolt', 38: 'fas fa-cloud-bolt', 47: 'fas fa-cloud-bolt', 5: 'fas fa-snowflake', 6: 'fas fa-snowflake', 7: 'fas fa-snowflake', 8: 'fas fa-snowflake', 10: 'fas fa-cloud-sleet', 18: 'fas fa-smog', 13: 'fas fa-snowflake', 14: 'fas fa-snowflake', 15: 'fas fa-snowflake', 16: 'fas fa-snowflake', 41: 'fas fa-snowflake', 42: 'fas fa-snowflake', 43: 'fas fa-snowflake', 46: 'fas fa-snowflake', 9: 'fas fa-cloud-rain', 19: 'fas fa-smog', 20: 'fas fa-smog', 21: 'fas fa-smog', 22: 'fas fa-smog', 23: 'fas fa-wind', 24: 'fas fa-wind' };
            return iconMap[iconCode] || 'fas fa-question-circle';
        }

        function updateDynamicSky() {
            const todayStr = new Date().toISOString().slice(0, 10);
            const todayForecast = allForecastDays.find(day => new Date(day.date).toISOString().slice(0, 10) === todayStr);

            const isDaytimeHours = new Date().getHours() >= 7 && new Date().getHours() < 18;
            let theme = isDaytimeHours ? 'day' : 'night';
            let currentPalette = theme === 'day' ? SKY_PALETTE.MORNING : SKY_PALETTE.DEEP_NIGHT;

            if (todayForecast && todayForecast.sunrise && todayForecast.sunset) {
                const sunriseTime = new Date(todayForecast.sunrise);
                const sunsetTime = new Date(todayForecast.sunset);
                const now = new Date();
                const dayDuration = (sunsetTime - sunriseTime);
                const timeSinceSunrise = (now - sunriseTime);
                
                const sunriseMinus90 = new Date(sunriseTime.getTime() - 90 * 60 * 1000);
                const sunriseMinus45 = new Date(sunriseTime.getTime() - 45 * 60 * 1000);
                const sunsetPlus45 = new Date(sunsetTime.getTime() + 45 * 60 * 1000);
                const sunsetPlus90 = new Date(sunsetTime.getTime() + 90 * 60 * 1000);

                if (now > sunriseTime && now < sunsetTime) {
                    theme = 'day';
                    const dayProgress = timeSinceSunrise / dayDuration;
                    if (dayProgress < 0.15) currentPalette = SKY_PALETTE.MORNING;
                    else if (dayProgress < 0.4) currentPalette = SKY_PALETTE.LATE_MORNING;
                    else if (dayProgress < 0.6) currentPalette = SKY_PALETTE.NOON;
                    else if (dayProgress < 0.85) currentPalette = SKY_PALETTE.AFTERNOON;
                    else currentPalette = SKY_PALETTE.SUNSET;
                } else {
                    theme = 'night';
                    if (now >= sunsetTime && now < sunsetPlus45) currentPalette = SKY_PALETTE.DUSK;
                    else if (now >= sunsetPlus45 && now < sunsetPlus90) currentPalette = SKY_PALETTE.EVENING;
                    else if (now < sunriseMinus90) currentPalette = SKY_PALETTE.DEEP_NIGHT;
                    else if (now < sunriseMinus45) currentPalette = SKY_PALETTE.PRE_DAWN;
                    else if (now < sunriseTime) currentPalette = SKY_PALETTE.DAWN;
                    else currentPalette = SKY_PALETTE.DEEP_NIGHT;
                }
            }
            
            document.body.dataset.theme = theme;
            document.documentElement.style.setProperty('--current-sky-color-top', currentPalette.top);
            document.documentElement.style.setProperty('--current-sky-color-bottom', currentPalette.bottom);
        }
        
        async function fetchDailyForecastData(lat, lon) {
            const url = `https://api.weather.com/v3/wx/forecast/daily/15day?geocode=${lat},${lon}&format=json&units=m&language=hu-HU&apiKey=${weatherComApiKey}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`API Hiba: ${response.status}`);
                const data = await response.json();
                if (!data || !data.dayOfWeek) throw new Error('Hiányos adatok.');
                const forecastDays = [];
                for(let i = 0; i < 15; i++) {
                    if (!data.dayOfWeek?.[i]) break;
                    
                    const dayPartData = data.daypart?.[0] ? { phrase: data.daypart[0].wxPhraseLong?.[i*2], precipChance: data.daypart[0].precipChance?.[i*2], windSpeed: data.daypart[0].windSpeed?.[i*2], windDir: data.daypart[0].windDirection?.[i*2], uvIndex: data.daypart[0].uvIndex?.[i*2], uvDescription: data.daypart[0].uvDescription?.[i*2], iconCode: data.daypart[0].iconCode?.[i*2], dayOrNight: data.daypart[0].dayOrNight?.[i*2], humidity: data.daypart[0].relativeHumidity?.[i*2], qpf: data.daypart[0].qpf?.[i*2], windGust: data.daypart[0].windGust?.[i*2] } : null;
                    const nightPartData = data.daypart?.[0] ? { phrase: data.daypart[0].wxPhraseLong?.[i*2+1], precipChance: data.daypart[0].precipChance?.[i*2+1], windSpeed: data.daypart[0].windSpeed?.[i*2+1], windDir: data.daypart[0].windDirection?.[i*2+1], iconCode: data.daypart[0].iconCode?.[i*2+1], dayOrNight: data.daypart[0].dayOrNight?.[i*2+1], humidity: data.daypart[0].relativeHumidity?.[i*2+1], qpf: data.daypart[0].qpf?.[i*2+1], windGust: data.daypart[0].windGust?.[i*2+1] } : null;

                    forecastDays.push({ dayName: data.dayOfWeek[i], date: data.validTimeLocal[i], tempMax: data.temperatureMax[i], tempMin: data.temperatureMin[i], dayPart: dayPartData, nightPart: nightPartData, sunrise: data.sunriseTimeLocal?.[i], sunset: data.sunsetTimeLocal?.[i] });
                }
                return { forecastDays };
            } catch (error) { console.error(`Adatlekérési hiba: ${error.message}`); throw error; }
        }
        
        function getTemperatureColor(temp) {
            const clampedTemp = Math.max(-10, Math.min(35, temp === null ? 15 : temp));
            const hue = 240 - (clampedTemp + 10) * (240 / 45);
            return `hsl(${hue}, 85%, 60%)`;
        }

        function renderForecastData(daysToRender) {
            const forecastContainerEl = document.getElementById('forecast-container');
            if (!forecastContainerEl || !daysToRender || daysToRender.length === 0) {
                if(forecastContainerEl) forecastContainerEl.innerHTML = '<div class="loading-message">Nincsenek megjeleníthető adatok.</div>';
                return;
            }

            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const todayDateStr = today.toISOString().slice(0, 10);
            const tomorrowDateStr = tomorrow.toISOString().slice(0, 10);
            
            let forecastHTML = '';
            daysToRender.forEach((day, index) => {
                if (!day.dayName || day.tempMax == null || day.tempMin == null) return;
                const forecastDateStr = new Date(day.date).toISOString().slice(0, 10);
                let specialClass = ''; let dayLabel = day.dayName;
                if (forecastDateStr === todayDateStr) { specialClass = 'today'; dayLabel = 'Ma'; } 
                else if (forecastDateStr === tomorrowDateStr) { specialClass = 'tomorrow'; dayLabel = 'Holnap'; }
                const tempColor = getTemperatureColor(day.tempMax);

                const dayWindText = day.dayPart ? `${degreesToCompass(day.dayPart.windDir)} ${formatValue(day.dayPart.windSpeed, ' km/h', 0)} ${day.dayPart.windGust ? `(lökés ${formatValue(day.dayPart.windGust, '', 0)})` : ''}` : NO_DATA_STRING;
                const nightWindText = day.nightPart ? `${degreesToCompass(day.nightPart.windDir)} ${formatValue(day.nightPart.windSpeed, ' km/h', 0)} ${day.nightPart.windGust ? `(lökés ${formatValue(day.nightPart.windGust, '', 0)})` : ''}` : NO_DATA_STRING;

                forecastHTML += `<div class="forecast-day-card ${specialClass}" style="--temp-color: ${tempColor}; --day-index: ${index};">
                    <div class="forecast-header">
                        <div class="forecast-day-name">${dayLabel}</div>
                        <div class="forecast-date">${formatForecastDate(day.date)}</div>
                    </div>
                    <div class="forecast-temps"><span class="forecast-temp-max">${formatValue(day.tempMax, '°', 0, '--')}</span><span class="forecast-temp-min">${formatValue(day.tempMin, '°', 0, '--')}</span></div>
                    
                    <div class="forecast-sun-details">
                        <span><span class="icon-combo"><i class="fas fa-sun icon-sunrise"></i><i class="fas fa-arrow-up icon-arrow up"></i></span>${formatTime(day.sunrise)}</span>
                        <span><span class="icon-combo"><i class="fas fa-sun icon-sunset"></i><i class="fas fa-arrow-down icon-arrow down"></i></span>${formatTime(day.sunset)}</span>
                    </div>`;
                
                if (day.dayPart) {
                    forecastHTML += `<div class="forecast-part">
                        <div class="forecast-part-header"><i class="${mapTwcIconToFontAwesome(day.dayPart.iconCode, day.dayPart.dayOrNight)}"></i>Nappal</div>
                        <div class="forecast-part-details">
                            <p>${day.dayPart.phrase || NO_DATA_STRING}</p>
                            <p><i class="fas fa-cloud-showers-heavy" style="width:14px; text-align:center; margin-right:4px;"></i>Csap.: ${formatValue(day.dayPart.precipChance, '%', 0)} (${formatPrecipitation(day.dayPart.qpf)})</p>
                            <p><i class="fas fa-wind" style="width:14px; text-align:center; margin-right:4px;"></i>Szél: ${dayWindText}</p>
                            <p><i class="fas fa-tint" style="width:14px; text-align:center; margin-right:4px;"></i>Pára: ${formatValue(day.dayPart.humidity, '%', 0)}</p>
                            <p><i class="fas fa-sun" style="width:14px; text-align:center; margin-right:4px;"></i>UV: ${formatValue(day.dayPart.uvIndex, '', 0)} (${day.dayPart.uvDescription || 'N/A'})</p>
                        </div>
                    </div>`;
                }

                if (day.nightPart) {
                    forecastHTML += `<div class="forecast-part">
                        <div class="forecast-part-header"><i class="${mapTwcIconToFontAwesome(day.nightPart.iconCode, day.nightPart.dayOrNight)}"></i>Éjjel</div>
                        <div class="forecast-part-details">
                            <p>${day.nightPart.phrase || NO_DATA_STRING}</p>
                            <p><i class="fas fa-cloud-showers-heavy" style="width:14px; text-align:center; margin-right:4px;"></i>Csap.: ${formatValue(day.nightPart.precipChance, '%', 0)} (${formatPrecipitation(day.nightPart.qpf)})</p>
                            <p><i class="fas fa-wind" style="width:14px; text-align:center; margin-right:4px;"></i>Szél: ${nightWindText}</p>
                            <p><i class="fas fa-tint" style="width:14px; text-align:center; margin-right:4px;"></i>Pára: ${formatValue(day.nightPart.humidity, '%', 0)}</p>
                        </div>
                    </div>`;
                }
                forecastHTML += `</div>`;
            });
            forecastContainerEl.innerHTML = forecastHTML;
        }

        function populateWeekSelector(forecastDays) {
            const weekSelector = document.getElementById('week-selector');
            if (!weekSelector || forecastDays.length === 0) return;
            weekSelector.innerHTML = '';
            if (forecastDays.length > 0) weekSelector.add(new Option('Első 7 nap', '0'));
            if (forecastDays.length > 7) {
                const remainingDays = forecastDays.length - 7;
                weekSelector.add(new Option(`Következő ${remainingDays} nap`, '7'));
            }
        }
        
        function handleWeekChange() {
            const weekSelector = document.getElementById('week-selector');
            const forecastContainer = document.getElementById('forecast-container');
            const dateRangeDisplay = document.getElementById('date-range-display');
            const startIndex = parseInt(weekSelector.value, 10);
            const isFirstWeek = startIndex === 0;

            const daysToShow = isFirstWeek ? allForecastDays.slice(0, 7) : allForecastDays.slice(7);

            if (isFirstWeek) {
                forecastContainer.classList.remove('eight-columns');
            } else {
                forecastContainer.classList.add('eight-columns');
            }
            
            if (daysToShow.length > 0) {
                const startDate = formatForecastDate(daysToShow[0].date);
                const endDate = formatForecastDate(daysToShow[daysToShow.length - 1].date);
                dateRangeDisplay.textContent = `${startDate} - ${endDate}`;
            } else {
                dateRangeDisplay.textContent = 'Nincs adat';
            }
            renderForecastData(daysToShow);
        }

        async function fetchAndRenderWeather() {
            const forecastContainerEl = document.getElementById('forecast-container');
            const lastUpdatedEl = document.getElementById('last-updated-time');
            try {
                const { forecastDays } = await fetchDailyForecastData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon);
                if (forecastDays && forecastDays.length > 0) {
                    lastUpdatedEl.textContent = formatLastUpdated(new Date());
                    allForecastDays = forecastDays;
                    populateWeekSelector(allForecastDays);
                    handleWeekChange();
                    updateDynamicSky(); 
                } else { throw new Error("Sikertelen adatfeldolgozás."); }
            } catch (error) {
                console.error("Hiba az időjárás adatok feldolgozása során:", error);
                if(forecastContainerEl) forecastContainerEl.innerHTML = `<div class="loading-message">⚠️ Hiba történt az előrejelzés frissítése közben. Kérjük, próbálja meg később!</div>`;
            }
        }

        function scheduleMidnightRefresh() {
            const now = new Date();
            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            const msUntilMidnight = tomorrow - now + 1000;
            setTimeout(() => {
                fetchAndRenderWeather();
                setInterval(fetchAndRenderWeather, 24 * 60 * 60 * 1000);
            }, msUntilMidnight);
        }

        function initApp() {
            document.getElementById('week-selector').addEventListener('change', handleWeekChange);
            fetchAndRenderWeather(); 
            setInterval(fetchAndRenderWeather, REFRESH_INTERVAL_MS);
            setInterval(updateDynamicSky, 60 * 1000);
            scheduleMidnightRefresh();
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
